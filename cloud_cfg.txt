#cloud-config
apt_update: true
apt_upgrade: true
packages:
 - git
 - celery
 - flask
 - python-pip
 - python-dev
 - build-essential
byobu_default: system
write_files:
  - path: /home/ubuntu/Dockerfile
    content: |
      FROM ubuntu
      RUN apt-get update
      RUN apt-get -y upgrade
      RUN apt-get install -y git
      RUN apt-get install -y python3-pip
      RUN pip install --upgrade pip
      RUN pip3 install celery
      RUN pip3 install flask
      RUN git clone https://github.com/Allow-tap/ACC_Celery_RabbitMQ.git
      WORKDIR /ACC_Celery_RabbitMQ
      EXPOSE 5000
      ENV PATH="${PATH}:/usr/games/"
      RUN celery -A pronoun_analysis worker --loglevel=INFO
      CMD ["python3","flask_app.py"]
runcmd:
 - sudo bash
 - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
 - add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
 - apt-get update
 - apt-get install -y rabbitmq-server 
 - apt-get install -y docker-ce
 - cd /home/ubuntu
 - docker build -t pronouns_twitter:latest .
 - docker run -d -p 5000:5000 pronouns_twitter &